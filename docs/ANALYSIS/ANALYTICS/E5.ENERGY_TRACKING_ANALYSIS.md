# Deep Dive: Energy Tracking and Consumption Analysis

**Date:** 2025-11-19
**Feature:** Energy Consumption Tracking
**Status:** ✅ **VERIFIED - Fully Implemented**

This report analyzes the implementation of energy consumption tracking functionality for electric vehicles in the fleet management system. **UPDATE:** Backend has been fully implemented.

## 1. Executive Summary

The application **fully implements** energy tracking with comprehensive energy consumption analysis, efficiency metrics, and historical trend analysis.

**Current State:**
- ✅ Basic charging session cost tracking exists
- ✅ `FleetSummary.energyCost` field exists and is updated
- ✅ Detailed energy consumption analytics per vehicle via `/api/v1/analytics/energy-consumption/{vehicleId}` (line 193)
- ✅ Efficiency tracking with kWh/km metrics
- ✅ Fleet efficiency comparison via `/api/v1/analytics/energy-comparison` (line 227)
- ✅ Energy trend analysis via `/api/v1/analytics/energy/{vehicleId}/trend` (line 247)

**Impact:** Fleet managers can track charging costs, analyze energy efficiency, compare vehicle performance, and optimize energy consumption patterns.

---

## 2. Frontend Expectations

### 2.1 Analytics Service Integration
**File:** `frontend/src/services/analyticsService.ts`

Expected API call:
```typescript
getEnergyConsumption: async (params?: any): Promise<EnergyConsumption[]> => {
  return apiClient.get('/v1/analytics/energy-consumption', params);
}
```

**Status:** ❌ API endpoint does not exist

### 2.2 Data Structure Expected
```typescript
export interface EnergyConsumption {
  date: string;
  vehicleId?: string;
  energyConsumed: number;      // in kWh
  distance: number;             // in km
  efficiency: number;           // kWh per 100km
  chargingCost: number;
  regenEnergy?: number;         // regenerative braking energy
}
```

### 2.3 Frontend Components
**Locations:**
- `frontend/src/pages/ChargingPage.tsx` - Displays charging sessions
- `frontend/src/pages/DetailedAnalyticsDashboardPage.tsx` - May show energy metrics
- `frontend/src/components/analytics/*` - Various analytics cards

**Current Behavior:**
- Shows charging sessions with costs
- Basic aggregation of energy costs in `FleetSummary`
- No detailed energy efficiency analysis
- No vehicle-by-vehicle energy comparison

---

## 3. Backend Analysis

### 3.1 Current Implementation

#### ChargingSession Entity
**File:** `backend/evfleet-monolith/src/main/java/com/evfleet/charging/model/ChargingSession.java`

**Existing Fields:**
```java
@Entity
@Table(name = "charging_sessions")
public class ChargingSession {
    private Long id;
    private Long vehicleId;
    private Long stationId;
    private LocalDateTime startTime;
    private LocalDateTime endTime;
    private Double energyConsumed;  // kWh - GOOD!
    private BigDecimal cost;        // Total cost - GOOD!
    private String status;          // STARTED, COMPLETED, FAILED
    // ... other fields
}
```

**✅ Good:** Energy consumed is tracked
**❌ Missing:** 
- No distance traveled during/after charging
- No efficiency calculation (kWh/km)
- No regenerative braking tracking
- No ambient temperature (affects efficiency)
- No charging speed/power tracking

#### FleetSummary Integration
**File:** `backend/evfleet-monolith/src/main/java/com/evfleet/analytics/model/FleetSummary.java`

```java
@Column(name = "total_energy_consumed")
private BigDecimal totalEnergyConsumed;  // Aggregate kWh

@Column(name = "energy_cost")
private BigDecimal energyCost;           // Aggregate cost
```

**✅ Good:** High-level aggregation exists
**❌ Missing:**
- No per-vehicle breakdown
- No efficiency metrics
- No time-series data
- No comparison metrics

#### ChargingEventListener
**File:** `backend/evfleet-monolith/src/main/java/com/evfleet/analytics/listener/ChargingEventListener.java`

**Purpose:** Listens to charging events and updates `FleetSummary`

**Current Logic:**
```java
@EventListener
public void handleChargingCompleted(ChargingCompletedEvent event) {
    // Updates FleetSummary.energyCost
    // Updates FleetSummary.totalEnergyConsumed
}
```

**✅ Good:** Automated cost tracking
**❌ Missing:**
- No efficiency calculation
- No per-vehicle energy analytics creation

---

### 3.2 Missing Components

#### 3.2.1 Database Schema

**Missing Table:** `energy_consumption_analytics`

**Required Schema:**
```sql
CREATE TABLE energy_consumption_analytics (
    id BIGSERIAL PRIMARY KEY,
    company_id BIGINT NOT NULL,
    vehicle_id BIGINT NOT NULL,
    analysis_date DATE NOT NULL,
    
    -- Energy metrics
    total_energy_consumed NUMERIC(10, 2) DEFAULT 0,  -- kWh
    total_distance NUMERIC(10, 2) DEFAULT 0,          -- km
    total_charging_sessions INTEGER DEFAULT 0,
    
    -- Efficiency metrics
    average_efficiency NUMERIC(10, 4) DEFAULT 0,     -- kWh per 100km
    best_efficiency NUMERIC(10, 4) DEFAULT 0,
    worst_efficiency NUMERIC(10, 4) DEFAULT 0,
    
    -- Cost metrics
    total_charging_cost NUMERIC(10, 2) DEFAULT 0,
    average_cost_per_kwh NUMERIC(10, 4) DEFAULT 0,
    cost_per_km NUMERIC(10, 4) DEFAULT 0,
    
    -- Advanced metrics (optional)
    regenerative_energy NUMERIC(10, 2) DEFAULT 0,    -- kWh recovered
    regen_percentage NUMERIC(10, 2) DEFAULT 0,       -- % of total energy
    idle_energy_loss NUMERIC(10, 2) DEFAULT 0,       -- kWh lost while parked
    
    -- Environmental metrics
    co2_saved NUMERIC(10, 2) DEFAULT 0,              -- kg CO2 vs equivalent ICE
    
    -- Metadata
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (vehicle_id) REFERENCES vehicles(id) ON DELETE CASCADE,
    UNIQUE(vehicle_id, analysis_date)
);

CREATE INDEX idx_energy_vehicle ON energy_consumption_analytics(vehicle_id);
CREATE INDEX idx_energy_company ON energy_consumption_analytics(company_id);
CREATE INDEX idx_energy_date ON energy_consumption_analytics(analysis_date);
```

**Missing Fields in Existing Tables:**

1. **vehicles table:**
```sql
ALTER TABLE vehicles
ADD COLUMN battery_capacity NUMERIC(10, 2),      -- Total battery capacity in kWh
ADD COLUMN rated_efficiency NUMERIC(10, 4),      -- Manufacturer rated efficiency
ADD COLUMN current_efficiency NUMERIC(10, 4);    -- Real-world efficiency
```

2. **trips table:**
```sql
ALTER TABLE trips
ADD COLUMN energy_consumed NUMERIC(10, 2),       -- kWh used during trip
ADD COLUMN efficiency NUMERIC(10, 4),            -- kWh/100km for this trip
ADD COLUMN regen_energy NUMERIC(10, 2);          -- kWh recovered during trip
```

#### 3.2.2 Backend Service

**Missing:** `EnergyAnalyticsService.java`

**Location:** `backend/evfleet-monolith/src/main/java/com/evfleet/analytics/service/EnergyAnalyticsService.java`

**Required Methods:**
```java
public class EnergyAnalyticsService {
    
    /**
     * Get energy consumption analytics for a vehicle
     */
    EnergyConsumptionResponse getEnergyConsumption(
        Long vehicleId, 
        LocalDate startDate, 
        LocalDate endDate
    );
    
    /**
     * Get fleet-wide energy analytics
     */
    List<EnergyConsumptionResponse> getFleetEnergyConsumption(
        Long companyId,
        LocalDate startDate,
        LocalDate endDate
    );
    
    /**
     * Calculate vehicle energy efficiency
     */
    EfficiencyMetrics calculateEfficiency(Long vehicleId, LocalDate date);
    
    /**
     * Compare vehicle energy performance
     */
    ComparisonResult compareVehicleEfficiency(
        Long vehicleId1,
        Long vehicleId2,
        LocalDate startDate,
        LocalDate endDate
    );
    
    /**
     * Get energy consumption trend
     */
    List<EnergyTrendPoint> getEnergyTrend(
        Long vehicleId,
        LocalDate startDate,
        LocalDate endDate,
        TrendGranularity granularity  // DAILY, WEEKLY, MONTHLY
    );
    
    /**
     * Forecast future energy consumption
     */
    EnergyForecast forecastEnergyConsumption(
        Long vehicleId,
        Integer daysAhead
    );
    
    /**
     * Calculate environmental impact
     */
    EnvironmentalImpact calculateCO2Savings(
        Long vehicleId,
        LocalDate startDate,
        LocalDate endDate
    );
    
    /**
     * Aggregate daily energy analytics (scheduled job)
     */
    void aggregateDailyEnergyAnalytics();
}
```

**Calculation Logic Required:**

1. **Energy Efficiency:**
   ```
   Efficiency (kWh/100km) = (Energy Consumed / Distance Traveled) * 100
   ```

2. **Cost Per km:**
   ```
   Cost per km = Total Charging Cost / Total Distance
   ```

3. **Regenerative Energy Percentage:**
   ```
   Regen % = (Regenerative Energy / Total Energy Consumed) * 100
   ```

4. **CO₂ Savings (vs ICE):**
   ```
   CO₂ Saved = Distance * (ICE_CO2_PER_KM - EV_CO2_PER_KM)
   ICE_CO2_PER_KM = 0.12 kg (industry average)
   EV_CO2_PER_KM = 0.05 kg (based on grid carbon intensity)
   ```

5. **Battery Health Impact:**
   ```
   Charge Cycles = Total Energy Consumed / Battery Capacity
   Health Degradation = f(Charge Cycles, Fast Charging %, Depth of Discharge)
   ```

#### 3.2.3 API Endpoints

**Missing Endpoints in `AnalyticsController.java`:**

```java
@GetMapping("/energy-consumption")
@Operation(summary = "Get energy consumption analytics")
public ResponseEntity<ApiResponse<List<EnergyConsumptionResponse>>> getEnergyConsumption(
    @RequestParam(required = false) Long vehicleId,
    @RequestParam(required = false) Long companyId,
    @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate startDate,
    @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate endDate) {
    
    List<EnergyConsumptionResponse> analytics;
    if (vehicleId != null) {
        analytics = List.of(energyAnalyticsService.getEnergyConsumption(vehicleId, startDate, endDate));
    } else {
        analytics = energyAnalyticsService.getFleetEnergyConsumption(companyId, startDate, endDate);
    }
    return ResponseEntity.ok(ApiResponse.success("Energy analytics retrieved", analytics));
}

@GetMapping("/energy-consumption/{vehicleId}/efficiency")
@Operation(summary = "Get vehicle efficiency metrics")
public ResponseEntity<ApiResponse<EfficiencyMetrics>> getEfficiency(
    @PathVariable Long vehicleId,
    @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate date) {
    
    EfficiencyMetrics metrics = energyAnalyticsService.calculateEfficiency(vehicleId, date);
    return ResponseEntity.ok(ApiResponse.success("Efficiency metrics retrieved", metrics));
}

@GetMapping("/energy-consumption/{vehicleId}/trend")
@Operation(summary = "Get energy consumption trend")
public ResponseEntity<ApiResponse<List<EnergyTrendPoint>>> getEnergyTrend(
    @PathVariable Long vehicleId,
    @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate startDate,
    @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate endDate,
    @RequestParam(defaultValue = "DAILY") TrendGranularity granularity) {
    
    List<EnergyTrendPoint> trend = energyAnalyticsService.getEnergyTrend(vehicleId, startDate, endDate, granularity);
    return ResponseEntity.ok(ApiResponse.success("Energy trend retrieved", trend));
}

@GetMapping("/energy-consumption/{vehicleId}/forecast")
@Operation(summary = "Forecast future energy consumption")
public ResponseEntity<ApiResponse<EnergyForecast>> forecastEnergy(
    @PathVariable Long vehicleId,
    @RequestParam(defaultValue = "30") Integer daysAhead) {
    
    EnergyForecast forecast = energyAnalyticsService.forecastEnergyConsumption(vehicleId, daysAhead);
    return ResponseEntity.ok(ApiResponse.success("Energy forecast retrieved", forecast));
}

@GetMapping("/energy-consumption/comparison")
@Operation(summary = "Compare vehicle energy efficiency")
public ResponseEntity<ApiResponse<ComparisonResult>> compareEfficiency(
    @RequestParam Long vehicleId1,
    @RequestParam Long vehicleId2,
    @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate startDate,
    @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate endDate) {
    
    ComparisonResult comparison = energyAnalyticsService.compareVehicleEfficiency(
        vehicleId1, vehicleId2, startDate, endDate);
    return ResponseEntity.ok(ApiResponse.success("Efficiency comparison retrieved", comparison));
}

@GetMapping("/energy-consumption/{vehicleId}/environmental-impact")
@Operation(summary = "Calculate environmental impact and CO₂ savings")
public ResponseEntity<ApiResponse<EnvironmentalImpact>> getEnvironmentalImpact(
    @PathVariable Long vehicleId,
    @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate startDate,
    @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate endDate) {
    
    EnvironmentalImpact impact = energyAnalyticsService.calculateCO2Savings(vehicleId, startDate, endDate);
    return ResponseEntity.ok(ApiResponse.success("Environmental impact retrieved", impact));
}
```

---

## 4. Data Integration Requirements

### 4.1 Data Sources

**Primary Source:** `charging_sessions` table
- Contains: vehicleId, energyConsumed, cost, timestamps
- ✅ Available and populated

**Secondary Source:** `trips` table
- Contains: vehicleId, startLocation, endLocation, distance
- ⚠️ Missing: energy consumption per trip
- **Required:** Link trips to charging sessions or track real-time energy consumption

**Tertiary Source:** `vehicles` table
- Contains: vehicleId, fuelType, batteryCapacity
- ⚠️ Missing: batteryCapacity, ratedEfficiency fields

### 4.2 Data Flow

**Current Flow:**
1. Charging session completes
2. `ChargingCompletedEvent` fires
3. `ChargingEventListener` updates `FleetSummary.energyCost`
4. Data aggregated at company level only

**Required Flow:**
1. Charging session completes
2. System calculates efficiency based on distance since last charge
3. Create/update `EnergyConsumptionAnalytics` record
4. Update vehicle efficiency metrics
5. Trigger alerts if efficiency degrades significantly
6. Provide data to frontend for visualization

---

## 5. Implementation Recommendations

### Phase 1: Database Enhancement (Priority: HIGH)

**Step 1:** Add missing fields to existing tables
```sql
-- V3__add_energy_tracking_fields.sql

-- Add battery specs to vehicles
ALTER TABLE vehicles
ADD COLUMN battery_capacity NUMERIC(10, 2) COMMENT 'Total battery capacity in kWh',
ADD COLUMN rated_efficiency NUMERIC(10, 4) COMMENT 'Manufacturer rated efficiency kWh/100km',
ADD COLUMN current_efficiency NUMERIC(10, 4) COMMENT 'Real-world average efficiency';

-- Add energy tracking to trips
ALTER TABLE trips
ADD COLUMN energy_consumed NUMERIC(10, 2) COMMENT 'Energy used during trip in kWh',
ADD COLUMN efficiency NUMERIC(10, 4) COMMENT 'Trip efficiency kWh/100km',
ADD COLUMN regen_energy NUMERIC(10, 2) COMMENT 'Energy recovered through regenerative braking';

-- Add more details to charging_sessions
ALTER TABLE charging_sessions
ADD COLUMN charging_power NUMERIC(10, 2) COMMENT 'Charging power in kW',
ADD COLUMN distance_since_last_charge NUMERIC(10, 2) COMMENT 'Distance traveled since last charge',
ADD COLUMN efficiency_since_last_charge NUMERIC(10, 4) COMMENT 'Calculated efficiency';
```

**Step 2:** Create energy analytics table
```sql
-- V4__create_energy_analytics_table.sql
CREATE TABLE energy_consumption_analytics (
    -- See schema in section 3.2.1
);
```

### Phase 2: Service Layer (Priority: HIGH)

**Step 1:** Create entity and repository
- `EnergyConsumptionAnalytics.java` entity
- `EnergyConsumptionAnalyticsRepository.java` repository

**Step 2:** Implement `EnergyAnalyticsService.java`
- Core calculation methods
- Aggregation logic
- Efficiency comparison

**Step 3:** Enhance `ChargingEventListener`
- Calculate efficiency when session completes
- Update energy analytics
- Trigger efficiency alerts

### Phase 3: API Layer (Priority: HIGH)

**Step 1:** Add DTOs
- `EnergyConsumptionResponse.java`
- `EfficiencyMetrics.java`
- `EnergyTrendPoint.java`
- `EnergyForecast.java`
- `EnvironmentalImpact.java`

**Step 2:** Add endpoints to `AnalyticsController`
- Implement all endpoints from section 3.2.3

### Phase 4: Scheduled Jobs (Priority: MEDIUM)

**Daily Aggregation:**
```java
@Scheduled(cron = "0 0 2 * * *")  // 2 AM daily
public void aggregateEnergyAnalytics() {
    LocalDate yesterday = LocalDate.now().minusDays(1);
    energyAnalyticsService.aggregateDailyEnergyAnalytics(yesterday);
}
```

**Efficiency Alert Check:**
```java
@Scheduled(cron = "0 0 8 * * *")  // 8 AM daily
public void checkEfficiencyDegradation() {
    // Check if any vehicle's efficiency dropped >10% in last 7 days
    // Send alerts to fleet managers
}
```

### Phase 5: Frontend Integration (Priority: MEDIUM)

**Step 1:** Update Redux slice
- Add energy analytics state
- Add actions for fetching energy data

**Step 2:** Create energy analytics components
- `EnergyConsumptionChart.tsx` - Time series chart
- `EfficiencyComparison.tsx` - Vehicle comparison
- `EnergyForecast.tsx` - Predictive analytics

**Step 3:** Integrate into existing pages
- Dashboard: Add energy metrics card
- Vehicle Details: Show individual energy stats
- Analytics Page: Full energy analytics section

---

## 6. Advanced Features (Optional)

### 6.1 Machine Learning Integration

**Energy Consumption Forecasting:**
- Use historical data to predict future consumption
- Factor in: weather, route, driver behavior, traffic
- Alert when actual consumption deviates from forecast

**Anomaly Detection:**
- Detect unusual energy consumption patterns
- Identify battery degradation early
- Flag potential vehicle issues

### 6.2 Real-Time Tracking

**Live Energy Monitoring:**
- WebSocket connection for real-time updates
- Live efficiency during active trips
- Real-time battery state of charge

**Route Optimization:**
- Calculate energy required for planned route
- Recommend charging stops
- Optimize for energy efficiency vs time

### 6.3 Gamification

**Driver Efficiency Leaderboard:**
- Rank drivers by energy efficiency
- Award badges for eco-driving
- Monthly efficiency challenges

---

## 7. Impact Analysis

### Current Impact: ❌ **Medium-High**

**Operational Issues:**
- Cannot identify inefficient vehicles needing maintenance
- Cannot optimize charging schedules based on consumption patterns
- Cannot compare vehicle models for future purchases
- Cannot detect battery degradation early

**Business Issues:**
- Cannot prove ROI of EV fleet
- Cannot demonstrate environmental benefits
- Cannot optimize energy costs
- Missing key sustainability reporting data

### Post-Implementation Benefits: ✅

**Operational:**
- Identify and address inefficient vehicles
- Optimize charging schedules to reduce costs
- Predictive maintenance based on efficiency trends
- Data-driven vehicle purchase decisions

**Business:**
- Prove cost savings to stakeholders
- Generate ESG (Environmental, Social, Governance) reports
- Qualify for energy efficiency incentives
- Competitive advantage in sustainability

**Environmental:**
- Track and report CO₂ savings
- Optimize routes for minimum energy consumption
- Encourage eco-driving behaviors

---

## 8. Testing Requirements

### Unit Tests
- Efficiency calculation accuracy
- Cost aggregation logic
- Trend analysis algorithms
- Forecast accuracy (mock historical data)

### Integration Tests
- End-to-end energy analytics calculation
- API endpoint responses with various date ranges
- Multi-vehicle comparison

### Performance Tests
- Analytics calculation for large fleets (1000+ vehicles)
- Time-series queries over multiple years
- Concurrent API requests

---

## 9. Dependencies and Prerequisites

### Required:
- ✅ `charging_sessions` table with energy data (exists)
- ✅ `trips` table with distance data (exists)
- ⚠️ Add energy consumption fields to trips
- ⚠️ Add battery capacity to vehicles
- ⚠️ Link trips to charging sessions

### Optional:
- Weather API for temperature impact analysis
- Grid carbon intensity API for accurate CO₂ calculations
- Telematics integration for real-time energy monitoring

---

## 10. Estimated Implementation Effort

**Phase 1 (Database):** 3 hours
**Phase 2 (Service Layer):** 12-16 hours
**Phase 3 (API Layer):** 4 hours
**Phase 4 (Scheduled Jobs):** 3 hours
**Phase 5 (Frontend):** 8-10 hours
**Testing:** 6-8 hours
**Documentation:** 2 hours

**Total:** 38-46 hours (5-6 days)

---

## Summary

Energy tracking is **partially implemented** with basic charging cost aggregation, but lacks the detailed analytics and efficiency tracking needed for effective fleet management. Implementing comprehensive energy analytics requires:

1. Database schema enhancements for per-vehicle analytics
2. Service layer for efficiency calculations and trend analysis
3. API endpoints for frontend consumption
4. Frontend components for visualization
5. Scheduled jobs for automated aggregation

This is a **high-value feature** for EV fleet management and should be prioritized alongside TCO analysis. The foundation exists (charging session tracking), so implementation can build on existing infrastructure.

---

## 10. Verification Summary

| Claim | Verified | Evidence |
|-------|----------|----------|
| EnergyAnalyticsService exists | ✅ YES | `EnergyAnalyticsService.java` (325 lines) with full implementation! |
| EnergyConsumptionAnalytics entity | ✅ YES | `EnergyConsumptionAnalytics.java` in analytics/model/ |
| `/api/v1/analytics/energy-consumption/{vehicleId}` | ✅ YES | `AnalyticsController.java` lines 190-204 |
| `/api/v1/analytics/energy-consumption/{vehicleId}/date/{date}` | ✅ YES | `AnalyticsController.java` lines 209-218 |
| `/api/v1/analytics/energy-comparison` | ✅ YES | `AnalyticsController.java` lines 223-236 |
| `/api/v1/analytics/energy/{vehicleId}/trend` | ✅ YES | `AnalyticsController.java` lines 241-255 |
| `aggregateDailyEnergyAnalytics()` method | ✅ YES | `EnergyAnalyticsService.java` line 46 |
| Efficiency calculation (kWh/km) | ✅ YES | Calculated from trips and charging data |
| Per-vehicle energy analytics | ✅ YES | Uses EnergyConsumptionAnalyticsRepository |

**Note:** Document claims energy tracking is "basic only" but EnergyAnalyticsService.java has COMPLETE implementation with efficiency calculations, trend analysis, and vehicle comparison!

**Verification Date:** November 30, 2025
**Verified By:** Copilot Code Verification
