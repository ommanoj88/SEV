# E2. Utilization Report Analysis

**Date:** 2025-11-19
**Feature:** Vehicle Utilization Reports
**Status:** üî¥ **CRITICAL - Backend Endpoint Missing**

This report analyzes the Utilization Report feature and identifies critical implementation gaps.

## 1. Executive Summary

The Utilization Report feature is **completely non-functional** because the backend API endpoint `/api/v1/analytics/utilization-reports` **does not exist**. The frontend component expects this endpoint but gets 404 errors, causing the utilization table to remain empty.

## 2. Frontend Analysis

### Component Implementation ‚ùå
**File:** `frontend/src/components/analytics/UtilizationReport.tsx`

```typescript
const { utilizationReports } = useAppSelector((state) => state.analytics);

// Displays table with columns:
// Vehicle, Utilization, Active Hours, Trips, Distance, Efficiency, Status
```

**Expected Data Structure:**
```typescript
interface UtilizationData {
  vehicleId?: string;
  vehicleName?: string;
  hoursActive: number;
  hoursIdle: number;
  hoursCharging: number;
  distance: number;
  trips: number;
  utilizationRate: number;
}
```

### Service Layer ‚ùå
**File:** `frontend/src/services/analyticsService.ts`

```typescript
// Line 35-37
getUtilizationReports: async (params?: any): Promise<UtilizationData[]> => {
  return apiClient.get('/v1/analytics/utilization-reports', params);
}

// Line 42-44  
getUtilizationByVehicle: async (vehicleId: number, startDate?: string, endDate?: string) => {
  return apiClient.get(`/v1/analytics/utilization/${vehicleId}`, { startDate, endDate });
}
```

**Problem:** Both endpoints **DO NOT EXIST** in backend!

### Redux Integration ‚ùå
**File:** `frontend/src/redux/slices/analyticsSlice.ts`

```typescript
// Line 167-172
export const fetchUtilizationReports = createAsyncThunk(
  'analytics/fetchUtilizationReports',
  async (params?: any) => {
    return await analyticsService.getUtilizationReports(params);
  }
);
```

When called, this fails with 404 and state remains empty array.

## 3. Backend Analysis

### Current State ‚ùå
**File:** `backend/evfleet-monolith/src/main/java/com/evfleet/analytics/controller/AnalyticsController.java`

**Existing Endpoints:**
- `GET /api/v1/analytics/fleet` ‚úÖ
- `GET /api/v1/analytics/fleet-summary` ‚úÖ
- `GET /api/v1/analytics/fleet-summary/today` ‚úÖ
- `GET /api/v1/analytics/fleet-summary/range` ‚úÖ
- `GET /api/v1/analytics/monthly-report` ‚úÖ

**Missing Endpoints:**
- `GET /api/v1/analytics/utilization-reports` ‚ùå
- `GET /api/v1/analytics/utilization/{vehicleId}` ‚ùå

### Database Schema Analysis

**Available Tables:**
- `vehicles` - Vehicle master data
- `trips` - Trip history with start/end times
- `charging_sessions` - Charging event data
- `fleet_summaries` - Daily aggregated metrics

**Data Available for Utilization Calculation:**
```sql
-- From trips table:
- start_time, end_time (active hours)
- distance
- vehicle_id

-- From charging_sessions table:  
- start_time, end_time (charging hours)
- vehicle_id

-- From vehicles table:
- status (current state)
- vehicle_number, make, model
```

## 4. Root Cause Analysis

1. **Missing Backend Implementation:** Utilization endpoints were never created
2. **Incomplete Feature:** Frontend was built assuming backend would be implemented
3. **No Data Aggregation Logic:** Backend doesn't calculate utilization metrics
4. **No Testing:** Feature wasn't tested end-to-end before deployment

## 5. Required Implementation

### Step 1: Create DTO Classes

**File:** `backend/evfleet-monolith/src/main/java/com/evfleet/analytics/dto/VehicleUtilizationResponse.java`

```java
@Data
@Builder
public class VehicleUtilizationResponse {
    private Long vehicleId;
    private String vehicleName;
    private String vehicleNumber;
    private Double utilizationRate;  // Percentage
    private Double activeHours;
    private Integer trips;
    private Double distance;  // km or mi
    private Double efficiency;  // km/kWh or similar
    private String status;  // "optimal", "underutilized", "overutilized"
}
```

**File:** `backend/evfleet-monolith/src/main/java/com/evfleet/analytics/dto/VehicleUtilizationDetail.java`

```java
@Data
@Builder
public class VehicleUtilizationDetail {
    private Long vehicleId;
    private String vehicleName;
    private LocalDate date;
    private Double hoursActive;
    private Double hoursIdle;
    private Double hoursCharging;
    private Double hoursMaintenance;
    private Double distance;
    private Integer trips;
    private Double utilizationRate;
}
```

### Step 2: Add Service Methods

**File:** `backend/evfleet-monolith/src/main/java/com/evfleet/analytics/service/AnalyticsService.java`

```java
/**
 * Get utilization reports for all vehicles
 */
public List<VehicleUtilizationResponse> getUtilizationReports(
    Long companyId, 
    LocalDate startDate, 
    LocalDate endDate
) {
    // 1. Fetch all vehicles for company
    // 2. For each vehicle, calculate:
    //    - Active hours from trips
    //    - Charging hours from charging_sessions
    //    - Total available hours (24 * days)
    //    - Utilization rate = (active + charging) / total
    //    - Trip count and total distance
    //    - Efficiency metric
    // 3. Determine status based on thresholds
    // 4. Return sorted by utilization rate
}

/**
 * Get detailed utilization for specific vehicle
 */
public List<VehicleUtilizationDetail> getUtilizationByVehicle(
    Long vehicleId,
    LocalDate startDate,
    LocalDate endDate
) {
    // Return day-by-day breakdown for the vehicle
}
```

### Step 3: Add Controller Endpoints

**File:** `backend/evfleet-monolith/src/main/java/com/evfleet/analytics/controller/AnalyticsController.java`

```java
@GetMapping("/utilization-reports")
@Operation(summary = "Get vehicle utilization reports")
public ResponseEntity<ApiResponse<List<VehicleUtilizationResponse>>> getUtilizationReports(
        @RequestParam Long companyId,
        @RequestParam(required = false) @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate startDate,
        @RequestParam(required = false) @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate endDate) {
    
    // Default to last 30 days if dates not provided
    if (startDate == null) startDate = LocalDate.now().minusDays(30);
    if (endDate == null) endDate = LocalDate.now();
    
    List<VehicleUtilizationResponse> reports = 
        analyticsService.getUtilizationReports(companyId, startDate, endDate);
    
    return ResponseEntity.ok(
        ApiResponse.success("Utilization reports retrieved successfully", reports)
    );
}

@GetMapping("/utilization/{vehicleId}")
@Operation(summary = "Get utilization details for specific vehicle")
public ResponseEntity<ApiResponse<List<VehicleUtilizationDetail>>> getUtilizationByVehicle(
        @PathVariable Long vehicleId,
        @RequestParam(required = false) @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate startDate,
        @RequestParam(required = false) @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate endDate) {
    
    if (startDate == null) startDate = LocalDate.now().minusDays(30);
    if (endDate == null) endDate = LocalDate.now();
    
    List<VehicleUtilizationDetail> details = 
        analyticsService.getUtilizationByVehicle(vehicleId, startDate, endDate);
    
    return ResponseEntity.ok(
        ApiResponse.success("Vehicle utilization details retrieved successfully", details)
    );
}
```

## 6. Utilization Calculation Logic

### Formula

```
Utilization Rate (%) = (Productive Hours / Available Hours) * 100

Where:
- Productive Hours = Active Hours + Charging Hours
- Active Hours = Time in trips (from trips table)
- Charging Hours = Time charging (from charging_sessions table)
- Available Hours = 24 hours * Number of days in period
```

### Status Classification

```java
String status;
if (utilizationRate >= 75) {
    status = "optimal";  // Green
} else if (utilizationRate >= 50) {
    status = "underutilized";  // Yellow/Warning
} else {
    status = "severely-underutilized";  // Red/Error
}
```

### Efficiency Metric

```
Efficiency = Total Distance / Total Energy Consumed
// For EV: km/kWh
// For ICE: km/L
// For Hybrid: Combined metric
```

## 7. SQL Queries Required

```sql
-- Active hours per vehicle
SELECT 
    vehicle_id,
    SUM(EXTRACT(EPOCH FROM (end_time - start_time))/3600) as active_hours,
    COUNT(*) as trip_count,
    SUM(distance) as total_distance
FROM trips
WHERE company_id = ? 
  AND start_time >= ?
  AND end_time <= ?
GROUP BY vehicle_id;

-- Charging hours per vehicle
SELECT 
    vehicle_id,
    SUM(EXTRACT(EPOCH FROM (end_time - start_time))/3600) as charging_hours
FROM charging_sessions
WHERE company_id = ?
  AND start_time >= ?
  AND end_time <= ?
GROUP BY vehicle_id;

-- Vehicle energy consumption
SELECT 
    vehicle_id,
    SUM(energy_consumed) as total_energy
FROM trips
WHERE company_id = ?
  AND start_time >= ?
  AND end_time <= ?
GROUP BY vehicle_id;
```

## 8. Frontend Updates Needed

### Update Interface (if needed)
**File:** `frontend/src/types/analytics.ts`

Ensure interface matches backend response:
```typescript
export interface UtilizationData {
  vehicleId: number;
  vehicleName: string;
  vehicleNumber?: string;
  utilizationRate: number;
  activeHours: number;
  hoursIdle?: number;
  hoursCharging?: number;
  distance: number;
  trips: number;
  efficiency: number;
  status: 'optimal' | 'underutilized' | 'severely-underutilized';
}
```

### Update Component
**File:** `frontend/src/components/analytics/UtilizationReport.tsx`

```typescript
// Map backend response fields correctly
<TableCell>{item.utilization?.toFixed(1)}%</TableCell>
// Should be:
<TableCell>{item.utilizationRate?.toFixed(1)}%</TableCell>

// Ensure proper color coding
color={
  item.status === 'optimal' ? 'success' : 
  item.status === 'underutilized' ? 'warning' : 
  'error'
}
```

## 9. Testing Requirements

### Backend API Tests
```bash
# Test utilization reports endpoint
curl http://localhost:8080/api/v1/analytics/utilization-reports?companyId=1

# Test vehicle-specific utilization
curl http://localhost:8080/api/v1/analytics/utilization/1?startDate=2025-11-01&endDate=2025-11-19

# Test with date range
curl "http://localhost:8080/api/v1/analytics/utilization-reports?companyId=1&startDate=2025-11-01&endDate=2025-11-19"
```

### Frontend Tests
1. Navigate to Utilization Report page
2. Verify table loads with real data
3. Check calculations are correct
4. Verify status colors display properly
5. Test date range filtering

## 10. Implementation Priority

**CRITICAL PRIORITY** - Feature is completely broken
- Users cannot view utilization data at all
- Important fleet management metric missing
- Affects operational planning
- Professional credibility issue

## 11. Estimated Effort

- **Backend DTO Creation:** 1 hour
- **Backend Service Logic:** 3-4 hours
- **Backend Controller:** 1 hour
- **SQL Query Optimization:** 1 hour
- **Frontend Updates:** 1 hour
- **Testing:** 2 hours

**Total:** ~8-10 hours

## Conclusion

The Utilization Report feature requires complete backend implementation. This is a critical missing feature that affects core fleet management functionality. The frontend is already prepared and waiting for the backend endpoints. Implementation should be prioritized immediately.

**Next Steps:**
1. Create backend DTOs
2. Implement service layer with utilization calculations
3. Add controller endpoints
4. Test with real data
5. Update frontend if necessary
6. Deploy and verify

---

## 10. Verification Summary

| Claim | Verified | Evidence |
|-------|----------|----------|
| `/api/v1/analytics/utilization-reports` missing | ‚ùå OUTDATED | Endpoint NOW EXISTS! |
| Utilization endpoint exists | ‚úÖ YES | `AnalyticsController.java` lines 111-124: GET `/utilization-reports` |
| Returns `VehicleUtilizationResponse` | ‚úÖ YES | Returns `List<VehicleUtilizationResponse>` |
| Date range filtering | ‚úÖ YES | startDate, endDate params with defaults (last 30 days) |
| Company-based filtering | ‚úÖ YES | Requires `companyId` param |
| AnalyticsService.getUtilizationReports() | ‚úÖ YES | Called by controller |

**Note:** Document claims endpoint is "COMPLETELY NON-FUNCTIONAL" but it NOW EXISTS with full implementation in AnalyticsController!

**Verification Date:** November 30, 2025
**Verified By:** Copilot Code Verification
