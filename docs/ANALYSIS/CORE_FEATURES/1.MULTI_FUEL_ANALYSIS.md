# Deep Dive: Multi-Fuel Support Analysis

**Date:** 2025-11-19
**Feature:** Multi-Fuel Vehicle Support (EV, ICE, Hybrid)
**Status:** ⚠️ **Data Model Ready, Logic Missing**

This report analyzes the implementation of multi-fuel support in the `fleet` module.

## 1. Data Model Analysis (`Vehicle.java`)
The database schema and Java entity are **correctly designed** to support multiple fuel types in a single table (Single Table Inheritance pattern, but flattened).

| Field | Purpose | Relevance |
| :--- | :--- | :--- |
| `fuelType` | Enum (`EV`, `ICE`, `HYBRID`) | **Core Discriminator** |
| `batteryCapacity` | EV Energy Storage (kWh) | Required for `EV`, `HYBRID` |
| `currentBatterySoc` | EV State of Charge (%) | Required for `EV`, `HYBRID` |
| `fuelTankCapacity` | ICE Fuel Storage (Liters) | Required for `ICE`, `HYBRID` |
| `fuelLevel` | ICE Fuel Level (Liters) | Required for `ICE`, `HYBRID` |
| `engineType` | Engine spec (e.g., "V6", "Electric Motor") | Optional / Informational |

**Verdict:** The **Structure** is excellent. It allows a vehicle to be purely Electric, purely ICE, or Hybrid (using both sets of fields).

## 2. Business Logic Analysis (`VehicleService.java`)
This is where the implementation falls short.

### ❌ Critical Gap: Missing Conditional Validation
The `createVehicle` method in `VehicleService` simply saves the object. It does **NOT** validate that the required fields for a specific fuel type are present.

**Scenario 1 (Bug):**
*   **Input:** Create a vehicle with `fuelType = EV`.
*   **Missing:** `batteryCapacity`.
*   **Result:** **Success**. The system creates an EV with `null` battery capacity.
*   **Impact:** Range calculation and Charging logic will crash or return NaN later.

**Scenario 2 (Bug):**
*   **Input:** Create a vehicle with `fuelType = ICE`.
*   **Missing:** `fuelTankCapacity`.
*   **Result:** **Success**.
*   **Impact:** Fuel consumption tracking will fail.

**Scenario 3 (Bug):**
*   **Input:** Create a vehicle with `fuelType = HYBRID`.
*   **Missing:** `batteryCapacity` OR `fuelTankCapacity`.
*   **Result:** **Success**.
*   **Impact:** Hybrid mode logic will be inconsistent.

### ❌ Critical Gap: Missing State Validation
*   **EVs:** `currentBatterySoc` should be validated to be between 0 and 100. Currently, you can set it to 200 or -50.
*   **ICE:** `fuelLevel` should not exceed `fuelTankCapacity`. Currently, you can have 100L in a 50L tank.

## 3. API Layer Analysis (`VehicleRequest.java`)
The DTO has basic `@NotNull` checks for common fields (`make`, `model`, `year`), but **all fuel-specific fields are optional**.

```java
// Current DTO
private Double batteryCapacity; // Optional
private Double fuelTankCapacity; // Optional
```

This confirms that the API allows sending incomplete data.

## 4. Recommendations for "Multi-Fuel Support"
To make this feature "100% Working", you must implement a **Validator** in the Service layer:

1.  **If `fuelType == EV`**:
    *   Require `batteryCapacity` > 0.
    *   Require `defaultChargerType`.
    *   Ensure `fuelTankCapacity` is null (or ignore it).

2.  **If `fuelType == ICE`**:
    *   Require `fuelTankCapacity` > 0.
    *   Ensure `batteryCapacity` is null.

3.  **If `fuelType == HYBRID`**:
    *   Require **BOTH** `batteryCapacity` > 0 AND `fuelTankCapacity` > 0.

## 5. Frontend Verification (`AddVehicle.tsx`)
**Status:** ✅ **Better than Backend**

The frontend actually implements the logic that is missing in the backend!

*   **Conditional Fields:** The UI correctly toggles fields based on `FuelType`.
    *   If `EV`: Shows `batteryCapacity`, `range`. Hides `fuelTankCapacity`.
    *   If `ICE`: Shows `fuelTankCapacity`. Hides `battery`.
*   **Validation:** Uses `Yup` schema to enforce these rules client-side.

```typescript
// AddVehicle.tsx
if (fuelType === FuelType.EV || fuelType === FuelType.HYBRID) {
  Object.assign(baseSchema, {
    batteryCapacity: yup.number().required(...),
  });
}
```

**Risk:** A malicious user can bypass the frontend and send invalid data directly to the API, which will accept it (as noted in Section 2).

## Summary
The **Skeleton** is there, but the **Brain** is missing. The system trusts the user to provide the correct data for the chosen fuel type, which is a recipe for data integrity issues.
