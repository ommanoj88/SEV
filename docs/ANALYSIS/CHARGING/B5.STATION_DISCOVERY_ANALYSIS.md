# Deep Dive: Station Discovery Analysis

**Date:** 2025-11-19
**Feature:** Station Discovery (Geospatial & Filtering)
**Status:** ⚠️ **Naive Implementation / Missing Filters**

This report analyzes the implementation of Station Discovery.

## 1. Executive Summary
The Station Discovery feature uses a basic mathematical formula in SQL to find nearby stations. While functional for small datasets, it lacks the performance of a true spatial index (PostGIS) and **completely misses** essential EV filters (Connector Type, Power Output) in the API.

## 2. Backend Analysis (`ChargingStationRepository`, `Controller`)
**Status:** ⚠️ **Unscalable & Limited**

*   **Geospatial Query:**
    ```sql
    ORDER BY (6371 * acos(cos(radians(:latitude)) * cos(radians(latitude)) * ...))
    ```
    *   **Issue:** This is the "Haversine Formula" calculated on the fly for *every row* in the table. It causes a full table scan.
    *   **Performance:** Will degrade rapidly as the number of stations grows.
    *   **Solution:** Use a Spatial Database (PostGIS) with a `GIST` index and `ST_DWithin`.
*   **Missing Filters:**
    *   The API `GET /nearby` only accepts `lat`, `lon`, and `limit`.
    *   **Missing:** `connectorType` (CCS2 vs Type 2), `minPower` (e.g., >50kW), `maxPrice`.
    *   **Impact:** A driver with a CCS2 car might be routed to a CHAdeMO station.

## 3. Frontend Analysis (`StationMap.tsx`)
**Status:** ✅ **Good UI / Mapbox Dependency**

*   **Map Provider:** Uses `mapbox-gl`.
    *   **Requirement:** Needs a valid `REACT_APP_MAPBOX_TOKEN`. Without it, the map won't load.
*   **Markers:** Custom SVG markers for "Charging" (⚡) and "Fuel" (⛽).
*   **Popups:** Shows details like available ports and price.

## 4. Impact
*   **Range Anxiety:** Drivers might be sent to incompatible or slow chargers.
*   **App Slowness:** The "Find Nearby" feature will become slow as the network expands.
*   **Map Failures:** If the API key is missing or expired, the screen is blank.

## 5. Recommendations

### 1. Upgrade to PostGIS
*   Enable PostGIS extension.
*   Change `latitude`/`longitude` columns to a `GEOMETRY(Point, 4326)` column.
*   Use `WHERE ST_DWithin(location, :userLocation, :radius)` for instant results.

### 2. Add API Filters
*   Update `ChargingStationController` to accept `connectorType`, `minPower`, `status`.
*   Update the Repository query to filter *before* sorting by distance.

### 3. Fallback Map
*   Implement a fallback (e.g., OpenStreetMap / Leaflet) if the Mapbox token is missing.

## Summary
The current implementation is a "textbook example" of how to calculate distance, but not a production-ready solution for a fleet app.

---

## 10. Verification Summary

| Claim | Verified | Evidence |
|-------|----------|----------|
| Haversine formula in SQL | ✅ YES | `ChargingStationRepository.java` lines 25-33: Native query with `6371 * acos(cos(radians(:latitude)) * cos(radians(s.latitude)) * cos(radians(s.longitude) - radians(:longitude)) + sin(radians(:latitude)) * sin(radians(s.latitude)))` |
| Full table scan risk | ✅ YES | Query uses `ORDER BY` with Haversine calculation on every row - no spatial index used |
| API only accepts lat/lon/limit | ⚠️ PARTIAL | Repository method `findNearbyStations()` only takes `latitude`, `longitude`, `status`, `limit` |
| `chargerType` field exists | ✅ EXISTS | `ChargingStation.java` line 69: `private String chargerType; // CCS, CHAdeMO, Type2, etc.` |
| `powerOutput` field exists | ✅ EXISTS | `ChargingStation.java` line 72: `private Integer powerOutput; // Power output in kW` |
| API filters missing | ⚠️ CORRECTED | Fields exist in entity but `findNearbyStations()` does NOT filter by `chargerType` or `powerOutput` - doc claim is CORRECT |
| No PostGIS usage | ✅ CONFIRMED | No `ST_DWithin`, `GEOMETRY`, or PostGIS functions found in codebase |
| Mapbox dependency | ✅ CONFIRMED | Frontend uses `mapbox-gl` (requires `REACT_APP_MAPBOX_TOKEN`) |

**Note:** Document claims "Missing Filters" are accurate - while `chargerType` and `powerOutput` exist in the entity, the API does NOT expose these as query parameters for the nearby stations endpoint.

**Verification Date:** 2025-01-27
**Verified By:** Copilot Code Verification
