# Deep Dive: Cost Analytics Analysis

**Date:** 2025-11-19
**Feature:** Cost Analytics
**Status:** ⚠️ Partial

## 1. Executive Summary
Cost Analytics is **partially implemented**. The backend has the database structure and cost breakdown columns (maintenance_cost, fuel_cost, energy_cost) added via migration V2, but the API endpoints for granular cost analytics are missing. The frontend has comprehensive UI components and service calls, but the backend only supports cost tracking through the FleetSummary entity, not as a separate, detailed cost analytics feature.

## 2. Backend Analysis
**Status:** ⚠️ Partial Implementation

*   **Entities:**
    *   **Reuses `FleetSummary` entity** which has:
        *   `totalCost` (BigDecimal)
        *   `maintenanceCost` (BigDecimal) - Added in V2 migration
        *   `fuelCost` (BigDecimal) - Added in V2 migration
        *   `energyCost` (BigDecimal) - Added in V2 migration
    *   **No dedicated `CostAnalytics` entity** for more granular tracking
    *   No separate table for itemized cost tracking (e.g., individual maintenance costs, charging costs per session)

*   **Logic:**
    *   **Service Layer** (`AnalyticsService.java`):
        *   `updateMaintenanceCost()` - Updates maintenance cost and total cost
        *   Cost data stored at daily summary level only
        *   No methods for: `getCostAnalytics()`, `getCostAnalyticsByVehicle()`, cost breakdown by category
    *   **Controller Layer** (`AnalyticsController.java`):
        *   **Missing endpoints** that frontend expects:
            *   `/api/v1/analytics/cost-analytics` (404)
            *   `/api/v1/analytics/cost-analytics/{vehicleId}` (404)
        *   Only aggregate costs available through `/api/v1/analytics/fleet-summary`
    *   **Cost Tracking Integration:**
        *   `ChargingEventListener` logs energy cost but doesn't call `updateFleetSummary()` with energy cost
        *   No integration with Maintenance module to capture actual maintenance costs
        *   No integration with Fuel module (for ICE vehicles) to capture fuel costs
    *   **Database Migration V2:**
        *   Successfully adds maintenance_cost, fuel_cost, energy_cost columns
        *   Initializes existing records to 0.00
        *   Proper comments on columns

*   **Missing:**
    *   **API Endpoints:** No dedicated cost analytics endpoints
    *   **Granular Tracking:** Cannot break down costs by:
        *   Vehicle-specific costs
        *   Cost type (parts, labor, electricity rate tiers)
        *   Time periods (daily, weekly, monthly trends)
        *   Cost per kilometer/mile
    *   **Fixed Costs:** No tracking of:
        *   Insurance costs (mentioned in frontend mock data)
        *   Registration/licensing fees
        *   Depreciation
        *   Loan/lease payments
    *   **Event Integration:** Listeners don't actually update cost fields
    *   **Cost Calculations:** No logic for:
        *   Total cost of ownership components
        *   Cost comparisons (EV vs ICE)
        *   Cost forecasting/budgeting

## 3. Frontend Analysis
**Status:** ⚠️ Partial (UI exists, API calls fail)

*   **Components:**
    *   **Redux Slice** (`analyticsSlice.ts`):
        *   `fetchCostAnalytics` async thunk
        *   `fetchCostAnalyticsByVehicle` async thunk
        *   `MOCK_COST_ANALYSIS` with energyCost, maintenanceCost, insuranceCost, otherCosts, totalCost, costPerKm, costPerVehicle
    *   **Service Layer** (`analyticsService.ts`):
        *   `getCostAnalytics()` → calls `/api/v1/analytics/cost-analytics`
        *   `getCostAnalyticsByVehicle()` → calls `/api/v1/analytics/cost-analytics/{vehicleId}`
    
*   **Integration:**
    *   **API Calls Fail:** Both endpoints return 404
    *   **Falls Back to Mock:** Uses `MOCK_COST_ANALYSIS` when API fails
    *   **Mock Data Shows:** October 2025 with ₹12,850 energy, ₹2,100 maintenance, ₹3,500 insurance, ₹800 other
    *   **UI Appears Functional:** Users see data but it's not real

## 4. Impact
**Business Impact:**
*   **Incomplete Cost Visibility:** Cannot track actual costs per vehicle or category
*   **Budget Planning Impossible:** No real data for forecasting or budget allocation
*   **No Fixed Cost Tracking:** Insurance, depreciation, and other fixed costs not captured
*   **ROI Calculations Inaccurate:** Cannot determine true cost per kilometer without all cost components
*   **Maintenance Costs Disconnected:** No integration with maintenance records

**Technical Impact:**
*   Data structure exists but unused (cost breakdown columns)
*   Frontend makes failing API calls
*   Event listeners incomplete (log but don't update)
*   Previous analysis (referenced in requirements) noted these gaps

## 5. Recommendations
1.  **Implement Missing API Endpoints:**
    *   `GET /api/v1/analytics/cost-analytics?companyId={id}&startDate={date}&endDate={date}`
    *   `GET /api/v1/analytics/cost-analytics/{vehicleId}`
    *   Return detailed cost breakdown arrays per period
2.  **Complete Event Integration:**
    *   Update `ChargingEventListener` to call `AnalyticsService.updateFleetSummary()` with energy cost
    *   Create `MaintenanceEventListener` to capture maintenance costs from completed maintenance records
    *   Add listener for fuel purchases (for ICE vehicles)
3.  **Add Fixed Costs Table:**
    *   Create `FixedCost` entity with fields: vehicleId, costType (INSURANCE, REGISTRATION, DEPRECIATION), amount, frequency, startDate, endDate
    *   Create API to manage fixed costs
    *   Include fixed costs in total cost calculations
4.  **Enhance Cost Calculations:**
    *   Calculate cost per kilometer: totalCost / totalDistance
    *   Calculate cost per day: totalCost / days active
    *   Add cost trending (month-over-month, year-over-year)
5.  **Create Cost Summary View:**
    *   Aggregate costs by category for easy visualization
    *   Support filtering by vehicle, time period, cost type
6.  **Add Budget Feature:**
    *   Allow setting cost budgets per vehicle or fleet
    *   Alert when costs exceed budget thresholds
    *   Forecast future costs based on historical data
