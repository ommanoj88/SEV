# Deep Dive: Historical Data Analysis

**Date:** 2025-11-19
**Feature:** Historical Data Analysis
**Status:** ⚠️ Partial

## 1. Executive Summary
Historical Data Analysis is **partially implemented**. While there is NO dedicated "history table" or "audit log" in the analytics module, the system does support historical data queries through the `FleetSummary` table with date-based queries. The `BaseEntity` class provides audit fields (createdAt, updatedAt) for all entities, but there's no comprehensive audit trail system. Historical analysis is limited to the granularity of daily fleet summaries.

## 2. Backend Analysis
**Status:** ⚠️ Partial Implementation

*   **Entities:**
    *   **FleetSummary** supports historical queries:
        *   Has `summaryDate` field for time-series data
        *   Can query by date ranges
    *   **BaseEntity** provides basic audit fields:
        *   `createdAt` (LocalDateTime)
        *   `updatedAt` (LocalDateTime)
        *   Present on all entities via inheritance
        *   Automatically managed by JPA lifecycle callbacks
    *   **No Dedicated History Tables:**
        *   No `vehicle_history` table
        *   No `trip_history_archive` table
        *   No `event_audit_log` table
        *   No separate audit schema
    *   **No Change Tracking:**
        *   No mechanism to track entity changes over time
        *   No "before" and "after" snapshots
        *   No user attribution for changes

*   **Logic:**
    *   **Service Layer** (`AnalyticsService.java`):
        *   `getFleetSummaryRange(companyId, startDate, endDate)` - Historical range queries
        *   `getMonthlyReport(companyId, year, month)` - Monthly aggregation
        *   These methods enable trend analysis over time
    *   **Repository** (`FleetSummaryRepository.java`):
        *   `findByCompanyIdAndSummaryDateBetween()` - Efficient date range queries
        *   Uses database indexes for performance
    *   **Controller Layer** (`AnalyticsController.java`):
        *   `GET /api/v1/analytics/fleet-summary/range` - Supports historical queries
        *   `GET /api/v1/analytics/monthly-report` - Monthly aggregation endpoint
    *   **Granularity:** Daily summaries only
        *   Cannot query hourly or minute-level historical data
        *   Raw trip/charging/maintenance data not aggregated for historical analysis
    *   **No Audit Trail:**
        *   Cannot answer: "Who changed this vehicle's status on Oct 15?"
        *   Cannot track: "What was the battery health 3 months ago?"
        *   Cannot see: "History of all maintenance records for vehicle"

*   **Missing:**
    *   **Comprehensive Audit System:**
        *   No audit log table to track all entity changes
        *   No user attribution (who made the change)
        *   No reason/comment field for changes
    *   **Entity History Tables:**
        *   No vehicle history snapshots
        *   No trip history archives
        *   No battery health history beyond current records
    *   **Change Tracking:**
        *   No diff tracking (what fields changed, old vs new values)
        *   No version history for entities
    *   **Retention Policies:**
        *   No archival strategy for old data
        *   No data lifecycle management
    *   **Historical Analytics:**
        *   No year-over-year comparisons
        *   No trend prediction based on historical patterns
        *   No anomaly detection using historical baselines

## 3. Frontend Analysis
**Status:** ⚠️ Limited Historical Views

*   **Components:**
    *   **Redux Slice** (`analyticsSlice.ts`):
        *   `fetchFleetSummary()` - Can accept date parameters
        *   No dedicated "historical analysis" UI components found
    *   **Service Layer** (`analyticsService.ts`):
        *   No specific "history" or "audit" service methods
        *   Relies on date range parameters in existing endpoints
    
*   **Integration:**
    *   **Date Range Filtering:** Frontend can request historical data by date range
    *   **Trend Visualization:** Components like `FleetAnalytics.tsx` show trends but limited to what backend provides
    *   **No Audit UI:** No component to view entity change history
    *   **No Historical Comparison:** No UI to compare "last month vs this month" or "same period last year"

## 4. Impact
**Business Impact:**
*   **Limited Trend Analysis:** Can see daily summaries but not hourly patterns
*   **No Compliance Audit Trail:** Cannot prove who made changes for regulatory compliance
*   **Limited Forensics:** Cannot investigate issues that occurred in the past (e.g., "Why did this vehicle's battery degrade suddenly?")
*   **No Accountability:** Cannot track user actions and changes
*   **Limited Forecasting:** Insufficient historical data granularity for accurate predictions

**Technical Impact:**
*   Basic audit fields (createdAt, updatedAt) provide minimal tracking
*   No mechanism to recover deleted data
*   Cannot revert changes or see what changed
*   Historical queries limited to what's stored in current tables

## 5. Recommendations
1.  **Implement Audit Log System:**
    *   Create `AuditLog` entity:
        ```java
        @Entity
        class AuditLog {
          id, entityType, entityId, action (CREATE, UPDATE, DELETE),
          userId, userName, timestamp, 
          oldValues (JSON), newValues (JSON), 
          changedFields (array), reason
        }
        ```
    *   Use JPA EntityListener or Spring AOP to automatically log changes
    *   Store before/after snapshots as JSON
2.  **Add History Tables for Critical Entities:**
    *   `vehicle_history` - Snapshot of vehicle state at regular intervals
    *   `battery_health_history` - Time-series battery health data
    *   `maintenance_history` - Already exists in maintenance module, ensure accessible for analytics
3.  **Enhance FleetSummary with Hourly Granularity:**
    *   Add option to store hourly summaries for more detailed analysis
    *   Keep daily summaries for long-term storage efficiency
    *   Implement data rollup: hourly → daily → monthly
4.  **Implement Data Retention Policies:**
    *   Define retention periods (e.g., raw data for 1 year, aggregated data for 5 years)
    *   Create archival jobs to move old data to cold storage
    *   Implement soft delete with recovery options
5.  **Add Historical Comparison APIs:**
    *   `GET /api/v1/analytics/compare?period1={start1-end1}&period2={start2-end2}`
    *   Enable year-over-year, month-over-month comparisons
    *   Return percentage changes and trends
6.  **Create Audit UI:**
    *   "View History" button on entity detail pages
    *   Timeline view showing all changes
    *   Filterable by date, user, action type
    *   Highlight what changed (diff view)
7.  **Add Time-Travel Queries:**
    *   Support queries like "Show me vehicle status as of Oct 15, 2025"
    *   Reconstruct entity state from audit log
8.  **Implement Versioning:**
    *   Use JPA @Version for optimistic locking
    *   Store full entity versions for critical changes
    *   Enable rollback functionality
9.  **Add Analytics on Historical Data:**
    *   Trend detection algorithms
    *   Anomaly detection (identify unusual patterns)
    *   Predictive analytics based on historical patterns
    *   Seasonal pattern recognition
10. **Performance Optimization:**
    *   Partition audit log table by date for efficient queries
    *   Create indexes on entityType, entityId, timestamp
    *   Consider using separate database for audit logs to avoid impacting operational performance
