# Deep Dive: Cost Calculation Analysis

**Date:** 2025-11-19
**Feature:** Cost Calculation & Expense Management
**Status:** ðŸ‘» **Ghost Feature (Expenses) / âš ï¸ Risky (Charging)**

This report analyzes the implementation of Cost Calculation and Expense Management.

## 1. Executive Summary
The system has a very basic cost calculation for charging sessions but **completely lacks** the backend for general Expense Management. The frontend for expenses is fully built but non-functional.

## 2. Backend Analysis (`ChargingSessionService`)
**Status:** âš ï¸ **Simplistic & Risky**

*   **Charging Cost Logic:**
    ```java
    BigDecimal cost = energyConsumed.multiply(BigDecimal.valueOf(station.getPricePerKwh()));
    ```
    *   **Issue 1:** `station.getPricePerKwh()` returns a `Double`. Converting `Double` to `BigDecimal` can introduce floating-point precision errors (e.g., `0.1` becoming `0.10000000000000000555`).
    *   **Issue 2:** No support for **Time-of-Use (TOU)** pricing (peak vs. off-peak).
    *   **Issue 3:** No support for **Taxes** (GST/VAT) or **Discounts**.
*   **Expense Management:**
    *   **Missing Entity:** No `Expense` entity found.
    *   **Missing Controller:** No `ExpenseController` found.
    *   **Result:** The entire Expense Management module is a **Ghost Feature**.

## 3. Frontend Analysis (`ExpenseManagementPage.tsx`)
**Status:** âœ… **Fully Implemented (UI)**

*   **Features:**
    *   Dashboard with charts (Pie/Bar) for expense categories.
    *   Table to list, approve, and reject expenses.
    *   Form to add expenses with categories (Fuel, Maintenance, Tolls, etc.).
*   **API Calls:**
    *   `POST /api/expenses` (Fails 404)
    *   `PUT /api/expenses/{id}/approve` (Fails 404)

## 4. Impact
*   **Financial Inaccuracy:** Rounding errors could lead to small but cumulative billing discrepancies.
*   **Compliance:** Lack of tax calculation makes the system illegal for commercial use in many jurisdictions.
*   **Operational Blindness:** Fleet managers cannot track maintenance, tolls, or driver wages because the backend doesn't exist.

## 5. Recommendations

### 1. Fix Pricing Logic
*   Change `pricePerKwh` in `ChargingStation` to `BigDecimal`.
*   Implement a `PricingStrategy` interface to support flat rates, TOU, and tiered pricing.

### 2. Implement Expense Backend
*   Create `Expense` entity, repository, and controller.
*   Implement approval workflows (Draft -> Pending -> Approved/Rejected).

### 3. Add Tax Support
*   Add `taxRate` to `ChargingStation` and calculate tax separately in the invoice.

## Summary
The system can calculate a basic charging fee (with potential math errors) but cannot track any other business expenses.
