# Deep Dive: Total Cost of Ownership (TCO) Analysis

**Date:** 2025-11-19
**Feature:** TCO (Total Cost of Ownership) Analysis
**Status:** ⚠️ **Partially Implemented - Frontend Only**

This report analyzes the implementation of Total Cost of Ownership (TCO) analysis functionality for EV fleet management.

## 1. Executive Summary

The application **claims** to provide TCO analysis as a core feature (mentioned in README and APPLICATION_OVERVIEW), and there is a fully functional frontend component (`TCOAnalysis.tsx`) that visualizes TCO comparisons between EV and ICE vehicles. However, there is **no backend implementation** to calculate, store, or serve actual TCO data.

**Current State:**
- ✅ Frontend: Complete TCO visualization with charts and comparisons
- ❌ Backend: No TCO calculation service
- ❌ Database: No `tco_analyses` table (mentioned in docs but doesn't exist)
- ❌ API Endpoints: No `/api/v1/analytics/tco-analysis/{vehicleId}` endpoint

**Impact:** The frontend displays hardcoded/mock TCO data with default values. Users cannot see actual TCO calculations based on their fleet's real operational data.

---

## 2. Frontend Analysis

### 2.1 TCOAnalysis Component (`frontend/src/components/analytics/TCOAnalysis.tsx`)
**Status:** ✅ **Fully Implemented and Production-Ready**

**Features:**
- ✅ Comprehensive TCO visualization with multiple chart types
- ✅ EV vs ICE cost comparison (Bar Chart)
- ✅ 5-year cost projection (Area Chart)
- ✅ Cost breakdown by category (Pie Chart)
- ✅ Key metrics cards (Total Savings, ROI, Payback Period, CO₂ Savings)
- ✅ Responsive design with mobile support
- ✅ Detailed insights and recommendations

**Data Structure Expected:**
```typescript
interface TCOAnalysis {
  vehicleId?: string;
  vehicleName?: string;
  purchasePrice: number;
  depreciation: number;
  energyCosts: number;
  maintenanceCosts: number;
  insuranceCosts: number;
  taxesFees: number;
  otherCosts: number;
  totalCost: number;
  costPerKm: number;
  costPerYear: number;
  comparisonWithICE?: {
    fuelSavings: number;
    maintenanceSavings: number;
    totalSavings: number;
    paybackPeriod: number; // in months
  };
}
```

**Current Behavior:**
The component uses Redux state (`state.analytics.tcoAnalysis`) but falls back to hardcoded defaults:
- Purchase Price: $45,000
- Energy Costs (5yr): $5,000
- Maintenance Costs (5yr): $2,000
- Insurance Costs (5yr): $2,500
- Total Savings vs ICE: $12,500
- Payback Period: 36 months
- ROI: 23.1%

### 2.2 Analytics Service Integration
**File:** `frontend/src/services/analyticsService.ts`

Expected API call:
```typescript
getTCOAnalysis: async (vehicleId: number): Promise<TCOAnalysis> => {
  return apiClient.get(`/v1/analytics/tco-analysis/${vehicleId}`);
}
```

**Issue:** This API endpoint does not exist in the backend.

---

## 3. Backend Analysis

### 3.1 Database Schema
**Status:** ❌ **Missing**

**Expected Table:** `tco_analyses` (mentioned in APPLICATION_OVERVIEW.md line 225)

**Required Schema:**
```sql
CREATE TABLE tco_analyses (
    id BIGSERIAL PRIMARY KEY,
    company_id BIGINT NOT NULL,
    vehicle_id BIGINT NOT NULL,
    analysis_date DATE NOT NULL DEFAULT CURRENT_DATE,
    
    -- Vehicle costs
    purchase_price NUMERIC(10, 2) NOT NULL,
    depreciation_value NUMERIC(10, 2) DEFAULT 0,
    
    -- Operating costs (lifetime or period-based)
    energy_costs NUMERIC(10, 2) DEFAULT 0,
    maintenance_costs NUMERIC(10, 2) DEFAULT 0,
    insurance_costs NUMERIC(10, 2) DEFAULT 0,
    taxes_fees NUMERIC(10, 2) DEFAULT 0,
    other_costs NUMERIC(10, 2) DEFAULT 0,
    
    -- Calculated totals
    total_cost NUMERIC(10, 2) NOT NULL,
    cost_per_km NUMERIC(10, 4) DEFAULT 0,
    cost_per_year NUMERIC(10, 2) DEFAULT 0,
    
    -- ICE comparison (for EVs)
    ice_fuel_savings NUMERIC(10, 2) DEFAULT 0,
    ice_maintenance_savings NUMERIC(10, 2) DEFAULT 0,
    ice_total_savings NUMERIC(10, 2) DEFAULT 0,
    ice_payback_period_months INTEGER DEFAULT 0,
    
    -- Metadata
    analysis_period_years INTEGER DEFAULT 5,
    total_distance_km NUMERIC(10, 2) DEFAULT 0,
    
    -- Audit fields
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by VARCHAR(255),
    updated_by VARCHAR(255),
    
    FOREIGN KEY (vehicle_id) REFERENCES vehicles(id) ON DELETE CASCADE
);

CREATE INDEX idx_tco_vehicle ON tco_analyses(vehicle_id);
CREATE INDEX idx_tco_company ON tco_analyses(company_id);
CREATE INDEX idx_tco_date ON tco_analyses(analysis_date);
```

### 3.2 Backend Service
**Status:** ❌ **Missing**

**Required:** `TCOAnalysisService.java`

**Location:** `backend/evfleet-monolith/src/main/java/com/evfleet/analytics/service/TCOAnalysisService.java`

**Core Methods Needed:**
```java
public class TCOAnalysisService {
    // Calculate TCO for a vehicle based on historical data
    TCOAnalysis calculateTCO(Long vehicleId, Integer years);
    
    // Get stored TCO analysis
    TCOAnalysis getTCOAnalysis(Long vehicleId);
    
    // Compare EV vs ICE costs
    ComparisonResult compareWithICE(Long vehicleId);
    
    // Recalculate TCO (scheduled job)
    void recalculateTCOForAllVehicles();
    
    // Get TCO trend over time
    List<TCOAnalysis> getTCOTrend(Long vehicleId, LocalDate startDate, LocalDate endDate);
}
```

**Calculation Logic Required:**

1. **Acquisition Costs:**
   - Purchase price (from vehicle entity)
   - Depreciation (based on age, mileage, vehicle type)

2. **Operating Costs:**
   - Energy costs: Aggregate from `charging_sessions` for EVs
   - Fuel costs: Aggregate from `fuel_consumption` table for ICE/Hybrid
   - Maintenance costs: Sum from `maintenance_schedules` table (already tracked via C5 implementation)
   - Insurance: Can be estimated or pulled from billing/expenses

3. **ICE Comparison (for EVs):**
   - Use industry benchmarks for equivalent ICE vehicle
   - Calculate savings: (ICE costs - EV costs)
   - Payback period: Initial premium / Annual savings

4. **Efficiency Metrics:**
   - Cost per km: Total cost / Total distance
   - Cost per year: Total cost / Vehicle age in years

### 3.3 API Controller
**Status:** ❌ **Missing**

**Required Endpoints in `AnalyticsController.java`:**

```java
@GetMapping("/tco-analysis/{vehicleId}")
@Operation(summary = "Get TCO analysis for a vehicle")
public ResponseEntity<ApiResponse<TCOAnalysisResponse>> getTCOAnalysis(
    @PathVariable Long vehicleId,
    @RequestParam(defaultValue = "5") Integer years) {
    TCOAnalysisResponse tco = tcoAnalysisService.calculateTCO(vehicleId, years);
    return ResponseEntity.ok(ApiResponse.success("TCO analysis retrieved", tco));
}

@GetMapping("/tco-analysis/{vehicleId}/comparison")
@Operation(summary = "Compare EV TCO with equivalent ICE vehicle")
public ResponseEntity<ApiResponse<TCOComparisonResponse>> compareTCO(
    @PathVariable Long vehicleId) {
    TCOComparisonResponse comparison = tcoAnalysisService.compareWithICE(vehicleId);
    return ResponseEntity.ok(ApiResponse.success("TCO comparison retrieved", comparison));
}

@GetMapping("/tco-analysis/{vehicleId}/trend")
@Operation(summary = "Get TCO trend over time")
public ResponseEntity<ApiResponse<List<TCOAnalysisResponse>>> getTCOTrend(
    @PathVariable Long vehicleId,
    @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate startDate,
    @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate endDate) {
    List<TCOAnalysisResponse> trend = tcoAnalysisService.getTCOTrend(vehicleId, startDate, endDate);
    return ResponseEntity.ok(ApiResponse.success("TCO trend retrieved", trend));
}

@PostMapping("/tco-analysis/recalculate")
@Operation(summary = "Manually trigger TCO recalculation for all vehicles")
public ResponseEntity<ApiResponse<String>> recalculateTCO(
    @RequestParam Long companyId) {
    tcoAnalysisService.recalculateTCOForCompany(companyId);
    return ResponseEntity.ok(ApiResponse.success("TCO recalculation started", null));
}
```

### 3.4 Data Integration Requirements

**Data Sources Needed:**
1. **Vehicle Information:** From `vehicles` table
   - Purchase price (need to add field if missing)
   - Purchase date
   - Current odometer reading
   - Vehicle type (EV/ICE/Hybrid)

2. **Energy/Fuel Costs:**
   - For EV: Query `charging_sessions` table, sum `cost` field
   - For ICE/Hybrid: Query `fuel_consumption` table (if tracking costs)
   - Aggregate by vehicle and date range

3. **Maintenance Costs:**
   - Query `maintenance_schedules` table
   - Filter by `status = COMPLETED`
   - Sum `cost` field
   - Already supported via `FleetSummary.maintenanceCost` (C5 implementation)

4. **Insurance & Other Costs:**
   - Query `expenses` table from billing module
   - Filter by expense type (INSURANCE, REGISTRATION, etc.)

5. **Trip Data:**
   - Query `trips` table for total distance traveled
   - Calculate utilization metrics

---

## 4. Integration Points

### 4.1 Existing Integrations to Leverage

**✅ Maintenance Cost Tracking:**
- Already implemented in `AnalyticsService.updateMaintenanceCost()`
- `FleetSummary` has `maintenanceCost` field
- Can aggregate from `FleetSummary` or directly from `maintenance_schedules`

**✅ Energy Cost Tracking:**
- `FleetSummary` has `energyCost` field
- `ChargingEventListener` updates energy costs
- Can aggregate from `charging_sessions`

**✅ Fuel Cost Tracking:**
- `FleetSummary` has `fuelCost` field
- Can track ICE/Hybrid fuel expenses

**⚠️ Missing Integrations:**
- No purchase price field in `vehicles` table
- No depreciation tracking
- No insurance cost tracking
- No taxes/fees tracking

---

## 5. Implementation Recommendations

### Priority 1: Database Setup
1. Create Flyway migration: `V3__create_tco_analyses_table.sql`
2. Add missing fields to `vehicles` table:
   ```sql
   ALTER TABLE vehicles 
   ADD COLUMN purchase_price NUMERIC(10, 2),
   ADD COLUMN purchase_date DATE;
   ```

### Priority 2: Backend Service Implementation
1. Create `TCOAnalysis` entity
2. Create `TCOAnalysisRepository`
3. Create `TCOAnalysisService` with calculation logic
4. Add endpoints to `AnalyticsController`
5. Create DTOs: `TCOAnalysisResponse`, `TCOComparisonResponse`

### Priority 3: Calculation Logic
1. **Aggregate Historical Costs:**
   - Query all cost sources for the vehicle
   - Group by year for trend analysis
   
2. **Calculate Depreciation:**
   - Use industry standard: 20% first year, 15% per year after
   - Or use: (Purchase Price - Salvage Value) / Useful Life
   
3. **ICE Comparison:**
   - Maintain lookup table for ICE equivalents
   - Use industry averages:
     * ICE fuel: ₹8-10/km
     * EV energy: ₹1.5-2/km
     * ICE maintenance: ₹2-3/km
     * EV maintenance: ₹0.5-1/km

### Priority 4: Scheduled Jobs
1. Create `@Scheduled` job to recalculate TCO monthly:
   ```java
   @Scheduled(cron = "0 0 1 1 * *") // 1st of every month
   public void monthlyTCOUpdate() {
       // Recalculate for all active vehicles
   }
   ```

### Priority 5: Frontend Integration
1. Update Redux slice to fetch real TCO data
2. Add loading states
3. Add error handling
4. Test with real backend data

---

## 6. Impact Analysis

### Current Impact: ❌ **High**
- **Business Decision Making:** Fleet managers cannot make informed EV vs ICE decisions
- **ROI Justification:** Cannot prove financial benefits of EV adoption
- **Cost Optimization:** Cannot identify which vehicles have poor TCO
- **Reporting:** Cannot generate accurate cost reports for stakeholders
- **Competitive Disadvantage:** Other fleet management systems provide real TCO analysis

### Post-Implementation Benefits: ✅
- **Data-Driven Decisions:** Real TCO data for vehicle selection
- **Financial Planning:** Accurate cost forecasting
- **Budget Optimization:** Identify high-cost vehicles
- **Regulatory Compliance:** Support EV incentive applications
- **Investor Reporting:** Demonstrate cost savings from EV transition

---

## 7. Testing Requirements

### Unit Tests
- TCO calculation logic with various scenarios
- Depreciation calculation accuracy
- ICE comparison calculations
- Edge cases (new vehicles, old vehicles, missing data)

### Integration Tests
- End-to-end TCO calculation from database
- API endpoint responses
- Multi-vehicle TCO analysis

### Performance Tests
- TCO calculation for 1000+ vehicles
- Scheduled job performance

---

## 8. Dependencies and Prerequisites

### Required:
- ✅ `FleetSummary` with cost breakdown (already implemented via C5)
- ✅ `MaintenanceSchedule` with cost tracking
- ✅ `ChargingSession` with cost tracking
- ⚠️ `vehicles.purchase_price` field (needs to be added)
- ⚠️ `expenses` table for insurance/taxes (exists in billing module)

### Optional:
- Historical market data for depreciation curves
- EV incentive/subsidy tracking
- Fuel price APIs for real-time cost updates

---

## 9. Estimated Implementation Effort

- **Database Schema:** 2 hours
- **Entity & Repository:** 2 hours
- **Service Layer (Calculation Logic):** 8-12 hours
- **API Controller & DTOs:** 3 hours
- **Frontend Integration:** 2 hours
- **Testing:** 4-6 hours
- **Documentation:** 2 hours

**Total:** 23-29 hours (3-4 days)

---

## Summary

The TCO Analysis feature is **advertised but not implemented**. The frontend is production-ready and waiting for backend data. Implementing this feature requires:

1. Creating the `tco_analyses` database table
2. Building calculation service with proper cost aggregation
3. Adding API endpoints
4. Integrating with existing cost tracking (maintenance, energy, fuel)
5. Adding missing vehicle fields (purchase price)

This is a **high-value feature** that directly impacts business decisions and should be prioritized. The frontend is ready, so implementation effort is primarily backend-focused.
