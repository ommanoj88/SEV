# Deep Dive: Real-time Tracking Analysis

**Date:** 2025-11-19
**Feature:** Real-time Vehicle Tracking
**Status:** üëª **Ghost Feature (Frontend Only) - Documented**

This report analyzes the implementation of the Real-time Tracking feature.

## 1. Executive Summary
**The backend WebSocket implementation does not exist.**

While the Frontend has a sophisticated Map component and a WebSocket client, the Backend **has zero WebSocket implementation**. The frontend is literally shouting into the void.

**Note:** Implementing a full WebSocket server is beyond the scope of minimal changes. This document recommends interim solutions.

## 2. Frontend Analysis (`VehicleMap.tsx`, `websocket.ts`)
**Status:** ‚úÖ **Implemented (Client-side)**

*   **Map Component:** `VehicleMap.tsx` uses Mapbox GL to render vehicles. It supports updating markers dynamically.
*   **WebSocket Client:** `websocket.ts` uses `socket.io-client` to try and connect to a WebSocket server.
*   **Events:** It listens for:
    *   `LOCATION_UPDATE`
    *   `BATTERY_UPDATE`
    *   `VEHICLE_STATUS_UPDATE`

```typescript
// websocket.ts
this.socket = io(WS_URL, { ... }); // Tries to connect
this.socket.on(WS_EVENTS.LOCATION_UPDATE, (data) => { ... }); // Listens for updates
```

## 3. Backend Analysis (`evfleet-monolith`)
**Status:** ‚ùå **Completely Missing**

*   **No WebSocket Config:** A search for `WebSocket`, `Socket`, `Stomp`, or `Messaging` in the backend returned **0 results**.
*   **No Socket.IO:** The frontend uses `socket.io-client`, which requires a specific Socket.IO server implementation (usually Node.js, or `netty-socketio` in Java). This library is **not present** in the Java backend.
*   **No Event Loop:** There is no background thread or scheduler pushing updates to connected clients.

## 4. The "Teleportation" Problem (Revisited)
Since Real-time tracking doesn't work, the only way to update location is via the REST API:
`PUT /api/v1/vehicles/{id}/location`

As noted in the Trip Analysis:
1.  This is a **destructive update** (overwrites previous location).
2.  It has **no history** (you can't see where the car was 5 minutes ago).
3.  It allows **teleportation** (jumping from London to New York in 1 second).

**‚úÖ UPDATE:** The Trip Management now includes geospatial validation to prevent teleportation during trip completion.

## 5. Recommended Solutions

### ‚úÖ Option A: Polling (Recommended Interim Solution)
*   **Frontend:** Delete `websocket.ts` or disable it. Use `setInterval` to call `GET /api/v1/vehicles` every 10-30 seconds.
*   **Backend:** No changes needed (uses existing REST API).
*   **Pros:** Simple, robust, works immediately with current infrastructure.
*   **Cons:** Higher server load than WebSockets, 10-30 second delay, not truly "real-time".
*   **Use Case:** Suitable for fleet management where exact real-time position is not critical.

### Option B: Implement WebSockets (Future Enhancement)
*   **Backend:** Add `spring-boot-starter-websocket`. Implement a `WebSocketHandler`.
*   **Frontend:** Switch from `socket.io-client` to `@stomp/stompjs` (standard for Spring Boot) OR implement `netty-socketio` in Java to keep the frontend as-is.
*   **Pros:** True real-time, efficient, scales well.
*   **Cons:** Complex to implement, requires infrastructure changes, needs testing for connection handling and failover.
*   **Timeline:** This is a major feature and should be planned as a separate enhancement.

## 6. Current Workaround
Until WebSocket is implemented, the system functions as follows:
1.  Vehicles update their location via REST API during trip completion
2.  Frontend can poll for updates periodically
3.  The map will show latest known positions, but with polling delay

## Summary
Real-time tracking is currently a UI illusion. The map will never move unless you refresh the page or implement polling, because the backend has no way to push updates to the browser.

**Recommendation:** Implement Option A (Polling) as an interim solution. Plan Option B (WebSockets) as a future enhancement when real-time tracking becomes a critical requirement.
