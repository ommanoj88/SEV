# Deep Dive: Maintenance Cost Analytics Analysis

**Date:** 2025-11-19
**Feature:** Maintenance Cost Analytics
**Status:** ❌ **Broken / Misleading**

This report analyzes the implementation of Maintenance Cost Analytics.

## 1. Executive Summary
The "Cost Analytics" feature is **misleading**. The frontend dashboard (`CostBreakdownCard`) displays *Trip Costs* (Fuel/Energy) but **completely ignores Maintenance Costs**. The backend has an `AnalyticsService` with a pre-aggregated `FleetSummary` table, but there is **no background job** to populate it, and it doesn't break down costs by maintenance type.

## 2. Backend Analysis (`AnalyticsService`)
**Status:** ⚠️ **Incomplete Implementation**

*   **Pre-Aggregation Strategy:**
    *   Uses `FleetSummary` table to store daily totals. This is a good design pattern for performance.
*   **Missing Population Logic:**
    *   There is no `@Scheduled` job to calculate daily totals.
    *   `MaintenanceService` does *not* call `AnalyticsService.updateFleetSummary` when a record is saved.
    *   **Result:** The analytics table will remain empty (all zeros).
*   **Lack of Granularity:**
    *   Only tracks `totalCost`.
    *   **Missing:** `maintenanceCost`, `fuelCost`, `laborCost`, `partsCost`.

## 3. Frontend Analysis (`CostBreakdownCard.tsx`)
**Status:** ❌ **Wrong Data Source**

*   **Data Source:**
    *   Calls `tripService.getCompanyCostSummary`.
    *   **Issue:** This service calculates cost based on *Trips* (Distance * Fuel Price). It **does not** query the `MaintenanceRecord` table.
*   **Visualization:**
    *   Shows "Energy Cost (EV)", "Fuel Cost (ICE)", "Hybrid Cost".
    *   **Missing:** "Maintenance Cost", "Repair Cost".

## 4. Impact
*   **Blind Spots:** A fleet manager might think their fleet is cheap to run because they only see fuel costs, while ignoring expensive repairs.
*   **Budget Failures:** Cannot forecast maintenance budgets.
*   **Data Discrepancy:** The "Total Cost" on the dashboard does not match the actual invoices.

## 5. Recommendations

### 1. Fix Data Ingestion
*   Update `MaintenanceService` to publish `MaintenanceCompletedEvent`.
*   Create `AnalyticsEventListener` to listen for this event and update `FleetSummary`.

### 2. Update Data Model
*   Add `maintenance_cost` column to `fleet_summary` table.
*   Add `maintenance_type_breakdown` (JSON) to store costs by category (Tires, Engine, etc.).

### 3. Update Frontend
*   Create a dedicated `MaintenanceCostCard` that queries `MaintenanceService` (or the updated Analytics API).
*   Show a Pie Chart of "Cost by Type" (Routine vs. Emergency).

## Summary
The current "Cost Breakdown" is actually a "Fuel Consumption Report". True Maintenance Analytics are missing.
